{% load static %}
{% with border_color="#bbb" %}
{% with lighter_border_color="#ccc" %}
<!DOCTYPE html>
<html>
  <head>
    <title>Visualization</title>
    <link rel="shortcut icon" href="{% static "img/favicon.ico" %}" type="image/x-icon" />
    <meta name="csrf_token" content="{{ csrf_token }}">
    <style type="text/css">
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      body {
        background-color: #fafafa;
        color: #111;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: sans-serif;
        height: fit-content;
      }
      .main-container {
        border-radius: 5px;
        border: solid 1px {{border_color}};
        background: #fcfcfc;
        width: 800px;
        display: flex;
        flex-direction: row;
        padding: 10px;
        gap: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .frame-container {
        display: flex;
        flex-direction: row;
        min-height: 400px;
        gap: 10px;
      }
      .active-video-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .navigation-container {
        margin-top: 40px;
        background: #fff;
        border-radius: 5px;
        border: solid 1px {{border_color}};
        positi
        width: 200px;
        overflow-y: scroll;
        max-height: 598px;
      }
      .video-entry {
        padding-left: 5px;
        padding-right: 5px;
        padding-top: 10px;
        padding-bottom: 5px;
        cursor: pointer;
      }
      .video-entry.selected {
        background: #e1e1e1;
        border-top: solid 1px #ccc;
        border-bottom: solid 1px #ccc;
      }
      .video-thumbnail {
        width: 150px;
      }
      .video-name {
        text-align: center;
        font-size: 80%;
      }
      #selected-video-name {
        font-size: 120%;
        border-bottom: solid 1px {{border_color}};
        padding-bottom: 5px;
      }
      #active-frame-container {
        width: 100%;
        height: 600px;
        background-color: #333;
        border-radius: 5px;
      }
      #active-frame-container td {
        text-align: center;
        vertical-align: middle;
      }
      img {
        max-width: 100%;
        height: auto;
      }
      .active-frame-tools {
        font-size: 80%;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }
      .video-position-info {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      .video-position-separator {
        margin-left: 2px;
        margin-right: 2px;
      }
      .video-position-info-label {
        margin-right: 5px;
        font-size: 120%;
      }
      #seeker, .layer-seeker {
        border-radius: 5px;
        height: 10px;
        width: 100%;
        background-color: #333;
        display: flex;
        flex-direction: row;
        align-items: center;
        position: relative;
      }
      .layer-seeker {
        overflow: hidden;
      }
      #seeker-filling {
        border-radius: 5px;
        position: absolute;
        background: #777;
        height: 10px;
        width: 0px;
      }
      #seeker-button {
        width: 16px;
        height: 16px;
        border-radius: 50px;
        border: solid 2px #555;
        background-color: #777;
        cursor: grab;
        z-index: 9999;
        position: absolute;
      }
      .seeker-nav-button {
        font-size: 120%;
        cursor: pointer;
        user-select: none;
        /*
        color: #ddd;
        width: 16px;
        height: 16px;
        border-radius: 50px;
        border: solid 2px #555;
        background-color: #777;
        flex-shrink: 0;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        */
      }
      .control-container {
        font-size: 80%;
      }
      .layers-label, .grid-label, .threed-visualization-label, .comments-label {
        border-bottom: solid 1px {{border_color}};
        padding-bottom: 2px;
        margin-bottom: 5px;
      }
      .layer-selection {
        display: flex;
        flex-direction: column;
      }
      .layer-selection>div {
        padding-top: 2px;
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      .layer-selection>div input[type="checkbox"] {
        margin-right: 4px;
      }
      .layer-selection>div:not(.indented-layer-div)>label:first-of-type {
        width: 250px;
      }
      .seeker-range-indicator {
        background: #0f0;
        position: absolute;
        z-index: 99999;
        height: 10px;
      }
      .layer-seeker-indicator {
        background: #f00;
        position: absolute;
        z-index: 999999999;
        height: 10px;
        width: 2px;
      }
      .layer-seeker-mouse-indicator {
        background: #fff;
        position: absolute;
        z-index: 999999999;
        height: 10px;
        width: 2px;
      }
      .indented-layer-div {
        margin-left: 39px;
      }
      #current-gt-activity {
        margin-left: 3px;
      }
      .active-frame {
        user-select: none;
        object-fit: cover;
      }
      .threed-visualization-label {
        width: 100%;
      }
      #threed-visualization-container {
        display: flex;
        flex-direction: column;
        align-items: start;
      }
      #threed-visualization-url-box {
        width: 200px;
      }
      .grid-label, .comments-label, .threed-visualization-label {
        margin-top: 7px;
      }
      .threed-visualization-control {
        margin-top: 5px;
        margin-bottom: 5px;
        display: flex;
        flex-direction: row;
        gap: 7px;
        align-items: center;
      }
      input[type="number"] {
        width: 30px;
      }
      .grid-control {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .grid-configurator-text-input {
        text-align: center;
      }
      .grid-history-button {
        margin-left: 3px;
      }
      .hand-mesh-track-history-container, .hand-mesh-filtering-container, .object-bbox-filtering-container, .segmentation-mask-filtering-container , .hos-filtering-container, .image-filtering-container, .tracking-bbox-filtering-container, .tracking-mask-filtering-container {
        display: flex;
        flex-direction: row;
        gap: 7px;
      }
      .hand-mesh-track-history-container input[type="number"] {
        width: 35px;
      }
      #filter-hand-border-clearance-box,
      #filter-object-confidence-box,
      #filter-tracking-mask-max-tortuosity-box,
      #filter-tracking-mask-merging-min-iou-box,
      #filter-tracking-mask-merging-min-ioa-box,
      #filter-tracking-mask-merging-min-fraction-box {
        width: 45px;
      }
      #filter-tracking-mask-max-cd-box, #filter-tracking-mask-max-hand-ioa-box {
        width: 55px;
      }
      #filter-hos-version-box {
        width: 140px;
      }
      #filter-segmentation-mask-area-box {
        width: 55px;
      }
      .hand-mesh-track-label {
        width: auto !important;
      }
      .hand-mesh-track-box {
        margin-right: -2px !important;
      }
      label[for="hand-mesh-track-left-box"] {
        color: #00f;
      }
      label[for="hand-mesh-track-right-box"] {
        color: #f00;
      }
      .separator {
        height: 1px;
        margin-top: 3px;
        padding: 0 !important;
        padding-top: 0 !important;
        width: 100%;
        align-self: center;
        background: {{lighter_border_color}};
      }
      .tracking-control-container>label {
        width: auto !important;
      }
      .tracking-control-container {
        gap: 5px;
      }
      .tracking-control-container input[type="checkbox"] {
        margin-right: 2px !important;
      }
      #filter-tracking-mask-ids, #filter-tracking-bbox-ids {
        width: 75px;
      }
      #seeker-speed-select {
        width: 60px;
      }
      #frame-detail-box-contents {
        display: flex;
        flex-direction: column;
      }
      #frame-detail-box-loading-label, #frame-detail-box-not-processed-label,
      .frame-detail-box-contents-no-detection-label, #no-comments-label {
        color: #777;
      }
      #comment-list {
        margin-top: 7px;
        margin-bottom: 5px;
        display: flex;
        flex-direction: column;

      }
      #comment-list .comment {
        display: flex;
        flex-direction: row;
        gap: 10px;
        padding: 5px;
        /*justify-content: center;*/
      }
      #comment-list .comment-frame-id, #comment-list .comment-image {
        text-align: center;
        cursor: pointer;
      }
      #comment-list textarea {
        width: 300px;
        height: 52px;
        padding: 6px;
      }
      #webrtc-container video {
        max-width: 645px;
      }
    </style>
    <script type="text/javascript">
      let byId = (id) => document.getElementById(id);
      window.seekerButtonMouseDownCoords = null;
      window.allChannels = ["image", "gt_activity", "hand_mesh", "hand_bbox", "hos", "segmentation_mask", "focus", "object_bbox", "tracking_bbox", "tracking_mask"];
      window.enabledChannels = ["image", "box_labels"];
      window.enabledTrackingChannels = [];
      window.detailedAvailabilityDataChunkSize = {{DETAILED_AVAILABILITY_DATA_CHUNK_SIZE}};
      {% autoescape off %}window.channelNameDict = {{CHANNEL_NAME_DICT_STR}};{% endautoescape %}
      {% autoescape off %}window.palette = [{{PALETTE_STR}}];{% endautoescape %}

      function debounce(func, timeout=300) {
        // from https://www.freecodecamp.org/news/javascript-debounce-example/
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
      }

      function fmtFrame(videoId, frameIdx) {
        return `${videoId}_${frameIdx.toString().padStart(7, "0")}`;
      }

      async function selectVideo(videoId) {
        if(!!window.activeVideo) {
          if(window.activeVideo == videoId)
            return;
          
          byId("video-position-frames").innerHTML = ".....";
          byId("video-duration-frames").innerHTML = ".....";


          byId("video-position-time").innerHTML = "..:..:..";
          byId("video-duration-time").innerHTML = "..:..:..";

          byId("video-entry-" + window.activeVideo).classList.remove("selected");

          byId("seeker-filling").style.width = "0px";
          byId("seeker-button").style.marginLeft = "0px";


          for(const channel of window.allChannels) {
            let seekerParent = byId("layer-seeker-" + channel.replace("_", "-"));
            if(!seekerParent)
              continue;
            let toRemove = [];
            for(child of seekerParent.children) {
              if([...child.classList].indexOf("seeker-range-indicator") > -1) {
                toRemove.push(child);
              }
            }
            for(remove of toRemove) {
              remove.parentElement.removeChild(remove);
            }
          }

          byId("grid-rows").value = 1;
          byId("grid-cols").value = 1;
        }

        for(let el of document.getElementsByClassName("active-frame"))
          el.src = "{% static "img/loading.png" %}";
        
        for(const channel of window.allChannels) {
          let seekerIndicator = byId("layer-seeker-indicator-" + channel.replace("_", "-"))
          if(!seekerIndicator)
            continue;
          seekerIndicator.style.left = "0px";
        }

        window.activeVideo = videoId;
        if(!!window.animationTimer)
          window.clearInterval(window.animationTimer);
        byId("video-entry-" + videoId).classList.add("selected");
        byId("selected-video-name").innerHTML = "🎥 " + videoId;

        response = await fetch("/get_video_data/"+ videoId +"/", {
          method: "GET",
          mode: "cors",
          cache: "no-cache",
          creditals: "same-origin"
        });

        let responseData = await response.json();
        window.videoData = responseData;
        window.numFrames = responseData["num_virtual_frames"];
        let dur = window.numFrames / window.videoData["virtual_fps"];
        window.videoDuration = dur;

        let vdfEl = byId("video-duration-frames");
        vdfEl.innerHTML = (window.numFrames-1).toString().padStart(5, "0");
        let vdtEl = byId("video-duration-time");
        vdtEl.innerHTML = Math.floor(dur / 3600).toFixed(0) +":"+ Math.floor((dur % 3600) / 60).toFixed(0).padStart(2, "0") +":"+ (dur % 60).toFixed(0).padStart(2, "0");

        selectFrame(0);

        foundImageVersions = [];
        foundHOSVersions = [];
        foundTrackingMaskMinLengths = [];
        foundSegmentationMaskVersions = [];
        foundObjectBboxVersions = [];
        foundHandMeshVersions = [];
        
        for(const channel of responseData["available_channels"] || []) {
          console.log(channel);

          if(channel.indexOf("hos_threshold") > -1) {
            let threshold = parseFloat(channel.split('=')[1]);
            let thresholdStr = "threshold=" + threshold.toString();
            foundHOSVersions.push(thresholdStr);
            if(thresholdStr != byId("filter-hos-version-box").value) {
              continue;
            }
          }
          else if(channel.indexOf("hos_egohos") > -1 || channel.indexOf("hos_ek-gt") > -1) {
            let version = channel.slice(channel.indexOf("_") + 1);
            foundHOSVersions.push(version);
            if(version != byId("filter-hos-version-box").value) {
              continue;
            }
          }
          else if(channel.startsWith("tracking_mask")) {
            let spl = channel.split('_');
            let matchImage = false;
            let matchHOSVersion = false;
            let matchMinLength = false;
            for(part of spl) {
              if(part.startsWith("image-type=")) {
                if(part.split("=")[1].replace("inpainted_", "").replace("depth_", "") == byId("filter-image-version-box").value.replace("inpainted_", "").replace("depth_", "")) {
                  matchImage = true;
                }
              }
              else if(part.startsWith("threshold=") || part == "egohos") {
                if(part == byId("filter-hos-version-box").value) {
                  matchHOSVersion = true;
                }
              }
              else if(part.startsWith("min-length=")) {
                let minLength = part.split("=")[1];
                if(foundTrackingMaskMinLengths.indexOf(minLength) == -1) {
                  foundTrackingMaskMinLengths.push(minLength);
                }
                if(minLength == byId("filter-tracking-mask-min-length-box").value) {
                  matchMinLength = true;
                }
              }
            }
          }
          else if(channel.indexOf("tracking_mask_egohos") > -1) {
            if("egohos" != byId("filter-hos-version-box").value) {
              continue;
            }
          }
          else if(channel.startsWith("segmentation_mask")) {
            foundSegmentationMaskVersions.push(channel.replaceAll("segmentation_mask_", ""));
          }
          else if(channel.startsWith("object_bbox")) {
            foundObjectBboxVersions.push(channel.replaceAll("object_bbox_", ""));
          }
          else if(channel.startsWith("hand_mesh")) {
            foundHandMeshVersions.push(channel.replaceAll("hand_mesh_", ""));
          }
          else if(channel == "image" || channel.indexOf("inpainted") > -1 || channel.indexOf("depth") > -1)
            foundImageVersions.push(channel);
        }
        
        updateSelectOptions(byId("filter-hos-version-box"), foundHOSVersions);
        updateSelectOptions(byId("filter-image-version-box"), foundImageVersions);
        updateSelectOptions(byId("filter-tracking-mask-min-length-box"), foundTrackingMaskMinLengths);
        updateSelectOptions(byId("filter-segmentation-mask-version-box"), foundSegmentationMaskVersions);
        updateSelectOptions(byId("filter-hand-mesh-version-box"), foundHandMeshVersions);
        updateSelectOptions(byId("filter-object-bbox-version-box"), foundObjectBboxVersions);

        let commentList = byId("comment-list");
        while(commentList.children.length > 0)
          commentList.removeChild(commentList.children[0]);

        if("comments" in responseData) {
          if(Object.keys(responseData["comments"]).length > 0) {
            byId("no-comments-label").style.display = "none";
            for(commentId of Object.keys(responseData["comments"])) {
              let commentData = responseData["comments"][commentId];
              console.log("commentData", commentData);
              addCommentToList(commentData);
            }
          }
          else
            byId("no-comments-label").style.display = "";
        }
        else
          byId("no-comments-label").style.display = "";
        
        // availability info

        foundImageVersions = [];
        foundHOSVersions = [];
        foundTrackingMaskMinLengths = [];
        foundSegmentationMaskVersions = [];
        foundObjectBboxVersions = [];
        foundHandMeshVersions = [];

        response = await fetch("/get_video_virtual_availability_data/"+ videoId +"/", {
          method: "GET",
          mode: "cors",
          cache: "no-cache",
          creditals: "same-origin"
        });
        responseData = await response.json();
        if(responseData["video_id"] != window.activeVideo)
          return;
        window.videoData["virtual_availability"] = responseData["virtual_availability"];

        channels = Object.keys(responseData["virtual_availability"]);
        for(const channel of channels) {
          console.log(channel);

          let seekerParent = null;
          if(channel.indexOf("hos_threshold") > -1) {
            let threshold = parseFloat(channel.split('=')[1]);
            let thresholdStr = "threshold=" + threshold.toString();
            foundHOSVersions.push(thresholdStr);
            if(thresholdStr != byId("filter-hos-version-box").value) {
              continue;
            }
            
            seekerParent = byId("layer-seeker-hos");
          }
          else if(channel.indexOf("hos_egohos") > -1 || channel.indexOf("hos_ek-gt") > -1) {
            let version = channel.slice(channel.indexOf("_") + 1);
            foundHOSVersions.push(version);
            if(version != byId("filter-hos-version-box").value) {
              continue;
            }
            
            seekerParent = byId("layer-seeker-hos");
          }
          else if(channel.startsWith("tracking_mask")) {
            let spl = channel.split('_');
            let matchImage = false;
            let matchHOSVersion = false;
            let matchMinLength = false;
            for(part of spl) {
              if(part.startsWith("image-type=")) {
                if(part.split("=")[1].replace("inpainted_", "").replace("depth_", "") == byId("filter-image-version-box").value.replace("inpainted_", "").replace("depth_", "")) {
                  matchImage = true;
                }
              }
              else if(part.startsWith("threshold=") || part == "egohos") {
                if(part == byId("filter-hos-version-box").value) {
                  matchHOSVersion = true;
                }
              }
              else if(part.startsWith("min-length=")) {
                let minLength = part.split("=")[1];
                if(foundTrackingMaskMinLengths.indexOf(minLength) == -1) {
                  foundTrackingMaskMinLengths.push(minLength);
                }
                if(minLength == byId("filter-tracking-mask-min-length-box").value) {
                  matchMinLength = true;
                }
              }
            }
            if(matchImage && matchHOSVersion && matchMinLength)
              seekerParent = byId("layer-seeker-tracking-mask");
          }
          else if(channel.indexOf("tracking_mask_egohos") > -1) {
            if("egohos" != byId("filter-hos-version-box").value) {
              continue;
            }
            
            seekerParent = byId("layer-seeker-tracking-mask");
          }
          else if(channel.startsWith("segmentation_mask")) {
            foundSegmentationMaskVersions.push(channel.replaceAll("segmentation_mask_", ""));
          }
          else if(channel.startsWith("object_bbox")) {
            foundObjectBboxVersions.push(channel.replaceAll("object_bbox_", ""));
          }
          else if(channel.startsWith("hand_mesh")) {
            foundHandMeshVersions.push(channel.replaceAll("hand_mesh_", ""));
          }
          else if(channel == "image" || channel.indexOf("inpainted") > -1 || channel.indexOf("depth") > -1)
            foundImageVersions.push(channel);
          else
            seekerParent = byId("layer-seeker-" + channel.replace("_", "-"));
          
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][channel]);
        }
        console.log("foundSegmentationMaskVersions", foundSegmentationMaskVersions);
        console.log("foundObjectBboxVersions", foundObjectBboxVersions);

        changeImageSource("image");
        changeHOSVersion(byId("filter-hos-version-box").value);
        changeSegmentationMaskVersion(byId("filter-segmentation-mask-version-box").value);
        changeHandMeshVersion(byId("filter-hand-mesh-version-box").value);
        changeObjectBboxVersion(byId("filter-object-bbox-version-box").value);

        window.videoData["detailed_virtual_availability"] = {}
        window.videoData["detailed_virtual_availability_end_frame"] = 0;

        for(let startFrame = 0; startFrame < window.numFrames; startFrame += window.detailedAvailabilityDataChunkSize) {
          let endFrame = startFrame + window.detailedAvailabilityDataChunkSize;
          response = await fetch("/get_detailed_video_virtual_availability_data/"+ videoId +`/?start_frame=${startFrame}&end_frame=${endFrame}`, {
            method: "GET",
            mode: "cors",
            cache: "no-cache",
            creditals: "same-origin"
          });
          responseData = await response.json();
          if(responseData["video_id"] != window.activeVideo)
            return;
          for(channel of Object.keys(responseData["virtual_availability"])) {
            let value = responseData["virtual_availability"][channel];
            if(!(channel in window.videoData["detailed_virtual_availability"]))
              window.videoData["detailed_virtual_availability"][channel] = value;
            else
              window.videoData["detailed_virtual_availability"][channel].push(...value);
          }
          window.videoData["detailed_virtual_availability_end_frame"] = responseData["end_frame"];
        }
      }

      function fillRangeIndicator(seekerParent, ranges) {
        if(!seekerParent)
          return;
        let toRemove = [];
        for(child of seekerParent.children) {
          if([...child.classList].indexOf("seeker-range-indicator") > -1) {
            toRemove.push(child);
          }
        }
        for(remove of toRemove) {
          remove.parentElement.removeChild(remove);
        }
        let seekerParentWidth = seekerParent.getBoundingClientRect().width;
        for(const range of ranges) {
          let startFrame = range[0];
          let endFrame = range[1];
          let rangeIndicator = document.createElement("div");
          rangeIndicator.className = "seeker-range-indicator";
          rangeIndicator.setAttribute("start-frame", startFrame);
          rangeIndicator.setAttribute("end-frame", endFrame);
          /*rangeIndicator.style.backgroundColor = window.palette[startFrame % window.palette.length];*/
          rangeIndicator.style.backgroundColor = window.palette[0];
          rangeIndicator.style.width = ((endFrame-startFrame) / window.numFrames * seekerParentWidth) + "px";
          rangeIndicator.style.left = ((startFrame+1) / window.numFrames * seekerParentWidth) + "px";
          seekerParent.appendChild(rangeIndicator);
        }
      }

      function selectFrame(frameIdx, doFetch = true) {
        if(frameIdx < 0)
          frameIdx = 0;
        if(frameIdx >= window.numFrames)
          frameIdx = window.numFrames-1;
        window.activeFrame = frameIdx;
        if(doFetch)
          fetchFrame();

        setSeekerPos(frameIdx);
      }

      function setSeekerPos(frameIdx) {
        let ratio = Math.min(1, Math.max(0, (frameIdx+1) / window.videoData["num_virtual_frames"]));
        let seekerEl = byId("seeker");
        let rect = seekerEl.getBoundingClientRect();
        let filling = byId("seeker-filling");
        let btnEl = byId("seeker-button");
        btnEl.style.marginLeft = (ratio * rect.width - btnEl.getBoundingClientRect().width / 2) + "px";
        filling.style.width = (ratio * rect.width) + "px";
        let vpfEl = byId("video-position-frames");
        vpfEl.innerHTML = frameIdx.toString().padStart(5, "0");
        
        let posTime = ratio * window.videoDuration;
        let vptEl = byId("video-position-time");
        vptEl.innerHTML = Math.floor(posTime / 3600).toFixed(0) +":"+ Math.floor((posTime % 3600) / 60).toFixed(0).padStart(2, "0") +":"+ (posTime % 60).toFixed(0).padStart(2, "0");

        for(const channel of window.allChannels) {
          console.log(channel);
          let seekerParent = byId("layer-seeker-" + channel.replace("_", "-"));
          if(!seekerParent)
            continue;
          let seekerIndicator = byId("layer-seeker-indicator-" + channel.replace("_", "-"))
          if(!seekerIndicator)
            continue;
          seekerIndicator.style.left = (ratio * seekerParent.getBoundingClientRect().width) + "px";
        }
      
        updateActivityLabel();
      }

      function toggleChannel(channel, enable) {
        if(!window.enabledChannels)
          window.enabledChannels = [];
        
        if(enable)
          window.enabledChannels.push(channel);
        else
          window.enabledChannels = window.enabledChannels.filter((str) => str != channel);
        
        fetchFrame();
      }

      function toggleTrackingChannel(channel, enable) {
        if(!window.enabledTrackingChannels)
          window.enabledTrackingChannels = [];
        
        if(enable)
          window.enabledTrackingChannels.push(channel);
        else
          window.enabledTrackingChannels = window.enabledTrackingChannels.filter((str) => str != channel);
        
        if(byId("layer-selection-box-tracking-bbox").checked)
          fetchFrame();
      }

      function fetchFrame() {
        let trackingMaskTypeStr = [...(byId("filter-tracking-mask-hands").checked ? ["left_hand", "right_hand"] : []), ...(byId("filter-tracking-mask-objects").checked ? ["object"] : [])].join(",");
        let trackingMaskMergingSchemeStr = [...(byId("filter-tracking-mask-merge-using-iou-box").checked ? ["iou"] : []), ...(byId("filter-tracking-mask-merge-using-ioa-box").checked ? ["ioa"] : [])].join(",");
        let frameLink = (frameIdx, delta) => ("/get_video_frame/"+ window.activeVideo +"/"+ frameIdx + "/?channels="+ window.enabledChannels.join(",")
                                              /*+ (delta == 0 && window.enabledChannels.indexOf("hand_mesh") > -1 ? `&hand_mesh_history=${byId("hand-mesh-track-history").value}&hand_mesh_step=${byId("hand-mesh-track-step").value}&hand_mesh_track_left=${byId("hand-mesh-track-left-box").checked ? "1" : "0"}&hand_mesh_track_right=${byId("hand-mesh-track-right-box").checked ? "1" : "0"}` : "")*/
                                              + `&filter_hand_border_clearance=${byId("filter-hand-border-clearance-box").value}&filter_object_confidence=${byId("filter-object-confidence-box").value}&filter_min_mask_area=${byId("filter-segmentation-mask-area-box").value}`
                                              + `&tracking_channels=${window.enabledTrackingChannels.join(",")}`
                                              + `&hos_version=${byId("filter-hos-version-box").value}`
                                              + `&tracking_mask_filter=${encodeURIComponent(byId("filter-tracking-mask-ids").value)}`
                                              + `&tracking_mask_types=${trackingMaskTypeStr}`
                                              + `&tracking_bbox_filter=${encodeURIComponent(byId("filter-tracking-bbox-ids").value)}`
                                              + `&max_width=640`
                                              + `&image_version=${byId("filter-image-version-box").value}`
                                              + `&tracking_mask_merge_tracks=${byId("filter-tracking-mask-merge-tracks-box").checked ? "1" : "0"}`
                                              + `&tracking_mask_merge_framewise=${byId("filter-tracking-mask-merge-framewise-box").checked ? "1" : "0"}`
                                              + `&tracking_mask_min_length=${byId("filter-tracking-mask-min-length-box").value}`
                                              + `&tracking_mask_max_tortuosity=${byId("filter-tracking-mask-max-tortuosity-box").value}`
                                              + `&tracking_mask_max_cd=${byId("filter-tracking-mask-max-cd-box").value}`
                                              + `&tracking_mask_max_ema_hand_ioa=${byId("filter-tracking-mask-max-hand-ioa-box").value}` 
                                              + `&tracking_mask_merging_min_iou=${byId("filter-tracking-mask-merging-min-iou-box").value}`
                                              + `&tracking_mask_merging_min_ioa=${byId("filter-tracking-mask-merging-min-ioa-box").value}`
                                              + `&tracking_mask_merging_min_fraction=${byId("filter-tracking-mask-merging-min-fraction-box").value}`
                                              + `&tracking_mask_merging_scheme=${trackingMaskMergingSchemeStr}`
                                              + `&segmentation_mask_version=${byId("filter-segmentation-mask-version-box").value}`
                                              + `&hand_mesh_version=${byId("filter-hand-mesh-version-box").value}`
                                              + `&object_bbox_version=${byId("filter-object-bbox-version-box").value}`);

        /*
          "filter-tracking-mask-merging-min-iou-box" onchange="javascript:fetchFrame();" />
          Min. IoU-thresholded frame fraction: <input type="number" min="0.0" max="1.0" step="0.001" id="filter-tracking-mask-merging-min-fraction-box

        */

        let activeFrameContainer = byId("active-frame-container");
        let configInputs = byId("grid-configurator").querySelectorAll("input");
        let imgChildren = activeFrameContainer.querySelectorAll("img");
        for(let childIdx = imgChildren.length - 1; childIdx >= 0; childIdx--) {
          let childEl = imgChildren[childIdx];

          let val = configInputs[childIdx].value.trim();

          //try {
            if(val == "0" || val[0] == "-" || val[0] == "+") {
              let delta = parseInt(val);
              if(isNaN(delta)) {
                throw Error();
              }
              let targetFrameIdx = window.activeFrame + delta;
              if(targetFrameIdx < 0 || targetFrameIdx >= window.numFrames) {
                throw Error();
              }
              childEl.src = frameLink(targetFrameIdx, delta);
            }
            else if(!isNaN(parseInt(val))) {
              childEl.src = frameLink(parseInt(val), NaN);
            }
            else if(val.indexOf("_") > -1) {
              let spl = val.split("_");
              childEl.src = "/get_video_frame/"+ spl.slice(0, -1).join("_") +"/"+ parseInt(spl[spl.length-1]).toString() + "/?channels="+ window.enabledChannels.join(",");
            }
            else {
              throw Error();
            }
          /*}
          catch {
            childEl.src = "{% static "img/no_image.png" %}";
          }*/
        }

        if(!!webRtcServerList && !!webRtcServerList["video_window_0"])
          webRtcServerList["video_window_0"].dataChannel.send(JSON.stringify({"class_name": "webapp/input", "frame_idx": window.activeFrame, "video_id": window.activeVideo}))
      }

      function seekerMouseUp(event) {
        if(!!window.seekerButtonMouseDownCoords) {
          endSeekerBtnDrag(event);
        }
        else {
          let el = event.target;
          let rect = el.getBoundingClientRect();
          let maxWidth = rect.width;
          let ratio = Math.min(1, Math.max(0, (event.clientX - rect.left) / maxWidth));
          selectFrame(Math.floor(ratio * window.videoData["num_virtual_frames"]));
        }
      }

      function seekerButtonMouseDown(event) {
        event.stopPropagation();
        let coords = [event.clientX, event.clientY];
        window.seekerButtonMouseDownCoords = coords;
        console.log(event);
      }

      function windowMouseMove(event) {
        if(!!window.seekerButtonMouseDownCoords) {
          let el = byId("seeker");
          let seekerRect = el.getBoundingClientRect();
          let targetRect = event.target.getBoundingClientRect();
          let translatedX = event.clientX - seekerRect.left;

          // translate to seeker coordinates
          selectFrame(Math.floor((translatedX / seekerRect.width) * window.numFrames), false);
        }
      }

      function endSeekerBtnDrag(event) {
        if(!!window.seekerButtonMouseDownCoords) {
          window.seekerButtonMouseDownCoords = null;
          selectFrame(window.activeFrame, true);
        }
      }

      function windowLeave(event) {
        endSeekerBtnDrag();
      }

      function windowMouseUp(event) {
        endSeekerBtnDrag();
      }

      function updateActivityLabel() {
        let cgtaSpan = byId("current-gt-activity");
          if(!!cgtaSpan) {
            let foundActivity = false;
            if(!!window.videoData && "virtual_availability" in window.videoData && "gt_activity" in window.videoData["virtual_availability"]) {
              for(region of window.videoData["virtual_availability"]["gt_activity"]) {
                if(region[0] > window.activeFrame)
                  break;
                
                if(region[0] <= window.activeFrame && window.activeFrame < region[1]) {
                  cgtaSpan.innerHTML = region[2] +" "+ region[3];
                  foundActivity = true;
                  break;
                }
              }
            }

            if(!foundActivity) {
              cgtaSpan.innerHTML = "?";
            }
        }
      }

      function animationStep() {
        if(window.activeFrame >= window.numFrames - 1) {
          toggleAnimation(false);
        }
        else {
          if([...document.getElementsByClassName("active-frame")].reduce(((acc,val) => acc && val.complete), true))
            window.selectFrame(window.activeFrame + parseInt(byId("seeker-speed-select").value));
        }
      }

      function toggleAnimation(enable) {
        if(enable) {
          if(!window.animationTimer) {
            window.animationTimer = window.setInterval(window.animationStep, 200);
            byId("seeker-play-pause-button").innerHTML = "⏸️";
            byId("seeker-play-pause-button").title = "Pause";
          }
        }
        else {
          if(!!window.animationTimer) {
            window.clearInterval(window.animationTimer);
            window.animationTimer = null;
            byId("seeker-play-pause-button").innerHTML = "▶️";
            byId("seeker-play-pause-button").title = "Play";
          }
        }
      }

      function recomputeGrid() {
        let gridRows = parseInt(byId("grid-rows").value);
        let gridCols = parseInt(byId("grid-cols").value);

        let currentGridRows = window.gridRows || 0;
        let currentGridCols = window.gridCols || 0;

        let gcEl = byId("grid-configurator");
        let contEl = byId("active-frame-container");

        // remove "oldest" first

        while(gcEl.children.length > gridRows) {
          gcEl.removeChild(gcEl.children[0]);
        }

        while(contEl.children.length > gridRows) {
          contEl.removeChild(contEl.children[0]);
        }

        while(gcEl.children.length > 0 && gcEl.children[0].children.length > gridCols) {
          for(let child of gcEl.children) {
            while(child.children.length > gridCols) {
              child.removeChild(child.children[0]);
            }
          }
        }

        while(contEl.children.length > 0 && contEl.children[0].children.length > gridCols) {
          for(let child of contEl.children) {
            while(child.children.length > gridCols) {
              child.removeChild(child.children[0]);
            }
          }
        }

        while(gcEl.children.length < gridRows) {
          let trEl = document.createElement("tr");
          gcEl.insertBefore(trEl, gcEl.firstChild);
        }

        while(contEl.children.length < gridRows) {
          let trEl = document.createElement("tr");
          contEl.insertBefore(trEl, contEl.firstChild);
        }

        for(let rowIdx = 0; rowIdx < gridRows; rowIdx++) {
          let trEl = gcEl.children[rowIdx];
          while(trEl.children.length < gridCols) {
            let tdEl = document.createElement("td");

            let textInput = document.createElement("input");
            textInput.className = "grid-configurator-text-input";
            textInput.type = "text";
            textInput.value = rowIdx == gridRows - 1 && trEl.children.length == 0 ? "0" : "?";
            textInput.size = 3;
            tdEl.appendChild(textInput);

            trEl.insertBefore(tdEl, trEl.firstChild);
          }
        }

        for(let rowIdx = 0; rowIdx < gridRows; rowIdx++) {
          let trEl = contEl.children[rowIdx];
          while(trEl.children.length < gridCols) {
            let tdEl = document.createElement("td");

            let imgEl = document.createElement("img");
            imgEl.className = "active-frame";
            imgEl.src = "{% static "img/no_image.png" %}";
            tdEl.appendChild(imgEl);

            trEl.insertBefore(tdEl, trEl.firstChild);
          }
        }

        window.gridRows = gridRows;
        window.gridCols = gridCols;

        fetchFrame();
      }

      function applyGridHistoryConfiguration() {
        let gcEl = byId("grid-configurator");
        let step = byId("grid-history-step").value;
        let next = 0;
        for(let trChildIdx = gcEl.children.length - 1; trChildIdx >= 0; trChildIdx--) {
          let trEl = gcEl.children[trChildIdx];
          for(let tdChildIdx = trEl.children.length - 1; tdChildIdx >= 0; tdChildIdx--) {
            let tdEl = trEl.children[tdChildIdx];
            let inputEl = tdEl.children[0];
            inputEl.value = next;
            next -= step;
          }
        }

        recomputeGrid();
      }

      function changeHOSVersion(version) { 
        if(!version)
          version = byId("filter-hos-version-box").value;
        {
          let seekerParent = byId("layer-seeker-hos");
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"]["hos_" + version] || []);
        }
        {
          let seekerParent = byId("layer-seeker-tracking-mask");
          let trackingChannelName = `tracking_mask_track=object_image-version=${byId("filter-image-version-box").value.replace("inpainted_", "").replace("_", "-")}_min-length=${byId("filter-tracking-mask-min-length-box").value}_${version}`;
          console.log(`trackingChannelName: ${trackingChannelName}`);
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][trackingChannelName] || []);
        }
        if(!!window.videoData["detailed_virtual_availability"])
          fetchFrame();
      }

      function changeSegmentationMaskVersion(version) {
        {
          let seekerParent = byId("layer-seeker-segmentation-mask");
          let channelName = `segmentation_mask_${byId("filter-segmentation-mask-version-box").value.replace("inpainted_", "")}`;
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][channelName] || []);
        }
        if(!!window.videoData["detailed_virtual_availability"])
          fetchFrame();
      }

      function changeHandMeshVersion(version) {
        {
          let seekerParent = byId("layer-seeker-hand-mesh");
          let channelName = `hand_mesh_${byId("filter-hand-mesh-version-box").value}`;
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][channelName] || []);
        }
        fetchFrame();
      }

      function changeObjectBboxVersion(version) {
        {
          let seekerParent = byId("layer-seeker-object-bbox");
          let channelName = `object_bbox_${byId("filter-object-bbox-version-box").value}`;
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][channelName] || []);
        }
        fetchFrame();
      }

      function changeImageSource(version) {
        {
          let seekerParent = byId("layer-seeker-image");
          if(!!window.videoData && !!window.videoData["virtual_availability"])
            fillRangeIndicator(seekerParent, window.videoData["virtual_availability"][version] || []);
        }
        /*trigger range indicator refill*/
        changeHOSVersion();
      }

      function changeTrackingMaskMinLength(minLength) {
        /*trigger range indicator refill*/
        changeHOSVersion();
      }
      
      function updateSelectOptions(selectElem, options) {
        selectElem.enabled = false;
        let prevValue = selectElem.value;
        let toRemove = [];
        for(child of selectElem.children) {
          toRemove.push(child);
        }
        for(remove of toRemove) {
          remove.parentElement.removeChild(remove);
        }
        options.sort();
        console.log("options:", options);
        for(option of options) {
          let optionElem = document.createElement("option");
          optionElem.value = option;
          if(option.startsWith("tracking_mask_")) {
            optionElem.innerHTML = `Tracking mask (${option.replace("tracking_mask__", "").replaceAll("__", ", ")})`;
          }
          else if(option.indexOf("threshold=") > -1) {
            optionElem.innerHTML = "VISOR, thres. " + option.split('=')[1];
          }
          else if(option == "egohos") {
            optionElem.innerHTML = "EgoHOS";
          }
          else if(option == "image") {
            optionElem.innerHTML = "Original";
          }
          else if(option == "inpainted_e2fgvi_egohos" || option == "e2fgvi_egohos") {
            optionElem.innerHTML = "E2FGVI inp. (EGOHos)";
          }
          else if(option.startsWith("depth")) {
            let depthVersion = option.slice(6);
            let depthVersionReadable = ({"midas2_video_scale": "MiDaS v2, video-scale", "cvd_video_scale": "CVD, video-scale",
                                         "midas2_section_scale": "MiDaS v2, section-scale", "cvd_section_scale": "CVD, section-scale"})[depthVersion] || depthVersion;
            optionElem.innerHTML = "Depth ("+ depthVersionReadable +")";
          }
          else if(option == "full_image") {
            optionElem.innerHTML = "Full image";
          }
          else if(option == "frankmocap") {
            optionElem.innerHTML = "FrankMocap";
          }
          else if(option == "tempclr") {
            optionElem.innerHTML = "TempCLR";
          }
          else if(option == "hand_minimal") {
            optionElem.innerHTML = "Minimal Hand";
          }
          else if(option == "unidet_image") {
            optionElem.innerHTML = "UniDet (original image)";
          }
          else if(option == "unidet_e2fgvi_egohos") {
            optionElem.innerHTML = "UniDet (E2FGVI on EgoHOS)";
          }
          else if(option == "ek-gt-dense") {
            optionElem.innerHTML = "EK VISOR (dense)";
          }
          else if(option == "ek-gt-sparse") {
            optionElem.innerHTML = "EK VISOR (sparse)";
          }
          else if(option.replaceAll("_", "-").endsWith("-gt-action-boundaries")) {
            optionElem.innerHTML = option.split("-")[0] + " (GT action boundaries)";
          }
          else {
            optionElem.innerHTML = option.toString();
          }
          selectElem.appendChild(optionElem);
        }
        selectElem.value = prevValue;
        selectElem.enabled = true;
      }

      function layerSeekerEntered(layerSeekerElement) {
        let frameDetailBox = byId("frame-detail-box");
        let layerSeekerRect = layerSeekerElement.getBoundingClientRect();
        let indicator = layerSeekerElement.querySelector(".layer-seeker-mouse-indicator");
        indicator.style.display = "";

        let channelId = layerSeekerElement.id.replace("layer-seeker-", "").replaceAll("-", "_");
        if(["image", "gt_activity"].indexOf(channelId) < 0) {
          frameDetailBox.style.left = `${layerSeekerRect.left}px`;
          frameDetailBox.style.top = `${layerSeekerRect.top + window.scrollY + layerSeekerRect.height + 10}px`;
          frameDetailBox.style.display = "";
        }
      }

      function layerSeekerLeft(layerSeekerElement) {
        let frameDetailBox = byId("frame-detail-box");
        let indicator = layerSeekerElement.querySelector(".layer-seeker-mouse-indicator");
        frameDetailBox.style.display = "none";
        indicator.style.display = "none";
        let frameDetailBoxContents = byId("frame-detail-box-contents");
        while(frameDetailBoxContents.children.length > 0)
          frameDetailBoxContents.removeChild(frameDetailBoxContents.children[0]);
      }

      function layerSeekerMouseMoved(layerSeekerElement, event) {
        if(!window.videoData)
          return;
        
        let frameDetailBox = byId("frame-detail-box");
        let indicator = layerSeekerElement.querySelector(".layer-seeker-mouse-indicator");
        
        let seekerRect = layerSeekerElement.getBoundingClientRect();
        let translatedX = event.clientX - seekerRect.left;

        indicator.style.left = `${translatedX}px`;
        let frameIdx = Math.floor((translatedX / seekerRect.width) * window.numFrames);
        let frameId = fmtFrame(window.activeVideo, frameIdx);
        let channelId = layerSeekerElement.id.replace("layer-seeker-", "").replaceAll("-", "_");
        let channelName = channelId in window.channelNameDict ? window.channelNameDict[channelId] : channelId;
        if(channelName.length >= 2 && channelName[0].toUpperCase() == channelName[0] && channelName[1].toLowerCase() == channelName[1]) {
          channelName = channelName[0].toLowerCase() + channelName.slice(1);
        }
        console.log(channelId);
        byId("frame-detail-box-title").innerText = "🖼️ " + frameId;
        byId("frame-detail-box-header-intern").innerText = `Available ${channelName} data`;

        let latestAvailableFrame = window.videoData["detailed_virtual_availability_end_frame"] || 0;
        let frameDetailBoxLoadingLbl = byId("frame-detail-box-loading-label");
        let frameDetailBoxNotProcessedLbl = byId("frame-detail-box-not-processed-label");
        let frameDetailBoxContents = byId("frame-detail-box-contents");
        if(latestAvailableFrame < frameIdx) {
          frameDetailBoxLoadingLbl.style.display = "";
          frameDetailBoxNotProcessedLbl.style.display = "none";
          frameDetailBoxContents.style.display = "none";
        }
        else {
          frameDetailBoxLoadingLbl.style.display = "none";

          let detailedAvailabilityChannel = null;

          if(["hand_bbox", "hos", "tracking_bbox", "object_bbox"].indexOf(channelId) > -1)
            detailedAvailabilityChannel = channelId;

          if(channelId == "hos") {
            detailedAvailabilityChannel = `hos_${byId("filter-hos-version-box").value}`;
          }
          else if(channelId == "tracking_mask") {
            detailedAvailabilityChannel = `tracking_mask_${byId("filter-hos-version-box").value}`;
          }
          else if(channelId == "segmentation_mask") {
            detailedAvailabilityChannel = `segmentation_mask_${byId("filter-segmentation-mask-version-box").value}`;
          }
          else if(channelId == "hand_mesh") {
            detailedAvailabilityChannel = `hand_mesh_${byId("filter-hand-mesh-version-box").value}`;
          }

          if(!!detailedAvailabilityChannel) {
            while(frameDetailBoxContents.children.length > 0)
              frameDetailBoxContents.removeChild(frameDetailBoxContents.children[0]);
            /*find region*/
            let found = false;
            console.log("detailedAvailabilityChannel", detailedAvailabilityChannel, detailedAvailabilityChannel in window.videoData["detailed_virtual_availability"]);
            if(detailedAvailabilityChannel in window.videoData["detailed_virtual_availability"]) {
              for(region of window.videoData["detailed_virtual_availability"][detailedAvailabilityChannel]) {
                let regionStart = region[0];
                let regionEnd = region[1];
                if(regionStart <= frameIdx && frameIdx < regionEnd) {
                  found = true;

                  frameDetailBoxContents.style.display = "";
                  frameDetailBoxNotProcessedLbl.style.display = "none";

                  if(["hand_mesh", "hand_bbox", "hos"].indexOf(channelId) > -1) {
                    let availability = region[2];
                    let descEl = document.createElement("div");
                    if(availability == "") {
                      descEl.className = "frame-detail-box-contents-no-detection-label";
                      descEl.innerText = "No detection";
                    }
                    else {
                      descEl.innerText = `${availability} (${regionStart} → ${regionEnd})`;
                    }

                    frameDetailBoxContents.appendChild(descEl);
                  }
                  else if(channelId == "tracking_bbox") {
                    let availability = region[2];
                    let numBoxesFound = 0;
                    let imageVersion = byId("filter-image-version-box").value;
                    let hosVersion = byId("filter-hos-version-box").value;
                      
                    for(availabilityChannelId of Object.keys(availability)) {
                      if((availabilityChannelId.startsWith("hos_") && ((!availabilityChannelId.startsWith(`hos_object_${hosVersion}`) && !availabilityChannelId.startsWith(`hos_hands_${hosVersion}`)) || !byId("layer-selection-box-hos").checked))
                        || (availabilityChannelId.startsWith("segmentation_mask") && !byId("layer-selection-box-segmentation-mask").checked)
                        || (availabilityChannelId.startsWith("object_bbox") && !byId("layer-selection-box-object-bbox").checked)
                        || (availabilityChannelId.startsWith("hand_bbox") && !byId("layer-selection-box-hand-bbox").checked)
                        || (availabilityChannelId.startsWith("tracking_mask") && !byId("layer-selection-box-tracking-mask").checked))
                        continue;

                      let channelAvailabilityData = availability[availabilityChannelId];
                      if(channelAvailabilityData.length > 0) {
                        let channelAvailabilityDataName = document.createElement("div");
                        channelAvailabilityDataName.style.fontWeight = "bold";
                        channelAvailabilityDataName.innerText = availabilityChannelId;
                        frameDetailBoxContents.appendChild(channelAvailabilityDataName);

                        for(trackingBboxId of channelAvailabilityData) {
                          let trackingBboxEl = document.createElement("div");

                          let fullBoundaries = null;
                          if(("tracking_bbox_boundaries" in window.videoData["detailed_virtual_availability"])
                             && trackingBboxId in window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2]) {
                              fullBoundaries = window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2][trackingBboxId];
                          }

                          if(!!fullBoundaries)
                            trackingBboxEl.innerText = `${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${fullBoundaries[0]} ↠ ${fullBoundaries[1]}; ${fullBoundaries[1]-fullBoundaries[0]})`;
                          else
                            trackingBboxEl.innerText = `${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${regionStart} → ${regionEnd}; ${regionEnd-regionStart})`;
                          frameDetailBoxContents.appendChild(trackingBboxEl);
                          numBoxesFound++;
                        }
                      }
                    }

                    if(numBoxesFound == 0) {
                      let descEl = document.createElement("div");
                      descEl.className = "frame-detail-box-contents-no-detection-label";
                      descEl.innerText = "No (active) detection; enable layers";
                      frameDetailBoxContents.appendChild(descEl);
                    }

                  }
                  break;
                }
              }
            }
            if(!found) {
              frameDetailBoxContents.style.display = "none";
              frameDetailBoxNotProcessedLbl.style.display = "";
            }
            else {
              /* check for detected tracking bboxes */
              if("tracking_bbox" in window.videoData["detailed_virtual_availability"]) {
                for(region of window.videoData["detailed_virtual_availability"]["tracking_bbox"]) {
                  let regionStart = region[0];
                  let regionEnd = region[1];
                  if(regionStart <= frameIdx && frameIdx < regionEnd) {
                    console.log("region[2]:", region[2]);
                    if(channelId == "hos") {
                      for(subChannel of ["hos_left_hand", "hos_right_hand", "hos_object"]) {
                        detailedAvailabilitySubChannel = detailedAvailabilityChannel.replace("hos_", `${subChannel}_`);
                        if(detailedAvailabilitySubChannel in region[2]) {
                          for(trackingBboxId of region[2][detailedAvailabilitySubChannel]) {
                            /*try to get full boundary: */
                            let fullBoundaries = null;
                            if(("tracking_bbox_boundaries" in window.videoData["detailed_virtual_availability"])
                               && trackingBboxId in window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2]) {
                                fullBoundaries = window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2][trackingBboxId];
                            }
                            let descEl = document.createElement("div");
                            if(!!fullBoundaries)
                              descEl.innerText = `${subChannel.split("_")[1][0].toUpperCase()}: ${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${fullBoundaries[0]} ↠ ${fullBoundaries[1]})`;
                            else
                              descEl.innerText = `${subChannel.split("_")[1][0].toUpperCase()}: ${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${regionStart} → ${regionEnd})`;
                            frameDetailBoxContents.appendChild(descEl);
                          }
                        }
                      }
                    }
                    else if(detailedAvailabilityChannel in region[2]) {
                      for(trackingBboxId of region[2][detailedAvailabilityChannel]) {
                        let descEl = document.createElement("span");
                        descEl.innerText = `${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${regionStart} → ${regionEnd})`;

                        let fullBoundaries = null;
                        if(("tracking_bbox_boundaries" in window.videoData["detailed_virtual_availability"])
                           && trackingBboxId in window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2]) {
                            fullBoundaries = window.videoData["detailed_virtual_availability"]["tracking_bbox_boundaries"][0][2][trackingBboxId];
                        }
                        if(!!fullBoundaries)
                          descEl.innerText = `${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${fullBoundaries[0]} ↠ ${fullBoundaries[1]})`;
                        else
                          descEl.innerText = `${trackingBboxId.substr(0,{{TRACKING_ID_SUBSTRING_LENGTH}})} (${regionStart} → ${regionEnd})`;
                        frameDetailBoxContents.appendChild(descEl);
                      }
                    }
                    break;
                  }
                } 
              }
            }
          }
        }
      }

      async function createComment2() {
        response = await fetch("/create_comment/"+ window.activeVideo +"/"+ window.activeFrame, {
          method: "GET",
          mode: "cors",
          cache: "no-cache",
          creditals: "same-origin"
        });

        let responseData = await response.json();
        addCommentToList(responseData);
      }

      function addCommentToList(commentData) {
        byId("no-comments-label").style.display = "none";

        let commentListEl = byId("comment-list");
        let commentEl = document.createElement("div");
        commentEl.className = "comment";
        if(!window.commentDataDict)
          window.commentDataDict = {}
        
        window.commentDataDict[commentData["comment_id"]] = commentData;
        commentEl.id = "comment-" + commentData["comment_id"];

        let commentImageContainerEl = document.createElement("div");
        let commentImageEl = document.createElement("img");
        commentImageEl.className = "comment-image";
        commentImageEl.src = `/get_video_frame/${commentData["video_id"]}/${commentData["frame_idx"]}/?channels=image&max_width=120`
        let commentFrameIDEl = document.createElement("div");
        commentFrameIDEl.className = "comment-frame-id";
        commentFrameIDEl.innerText = commentData["frame_id"];
        commentImageEl.onclick = () => { window.selectFrame(commentData["frame_idx"]); window.scrollTo({top: 0, behavior: "smooth"}) };
        commentFrameIDEl.onclick = () => { window.selectFrame(commentData["frame_idx"]); window.scrollTo({top: 0, behavior: "smooth"}) };

        commentImageContainerEl.appendChild(commentImageEl);
        commentImageContainerEl.appendChild(commentFrameIDEl);

        let commentTextEl = document.createElement("textarea");
        commentTextEl.placeholder = "Enter text here...";
        commentTextEl.value = commentData["text"];
        commentTextEl.onblur = (event) => updateComment(window.commentDataDict[(event.sender || event.srcElement).id.split("-")[2]]["video_id"], window.commentDataDict[(event.sender || event.srcElement).id.split("-")[2]]["frame_idx"], (event.sender || event.srcElement).id.split("-")[2], (event.sender || event.srcElement).value, commentEl.id);
        commentTextEl.id = "comment-text-" + commentData["comment_id"];

        commentEl.appendChild(commentImageContainerEl);
        commentEl.appendChild(commentTextEl);

        // sort comments

        let prevFrameIdx = "-1";
        let prevFrameComment = " ".repeat(100);
        let found = false;
        for(child of commentListEl.children) {
          //if(prevFrameIdx <= commentData["frame_id"] && commentData["frame_id"] < child.id.split("-frame_id=")[1]) {
          if(prevFrameComment <= commentData["text"] && commentData["text"] < child.querySelector("textarea").value) {
            commentListEl.insertBefore(commentEl, child);
            found = true;
            break;
          }
        }
        if(!found) {
          commentListEl.appendChild(commentEl);
        }
      }

      async function updateComment(video, frame, commentId, commentText, commentElementId) {
        if(commentText.trim() == "") {
          response = await fetch("/remove_comment/"+ video +"/"+ frame +"/"+ commentId + "/", {
            method: "GET",
            mode: "cors",
            cache: "no-cache",
            creditals: "same-origin"
          });
          let commentElement = byId(commentElementId);
          commentElement.parentElement.removeChild(commentElement);
          if(document.querySelectorAll(".comment").length == 0) {
            byId("no-comments-label").style.display = "";
          }
        }
        else {
          response = await fetch("/update_comment/"+ video +"/"+ frame +"/"+ commentId + "/?text=" + encodeURIComponent(commentText), {
            method: "GET",
            mode: "cors",
            cache: "no-cache",
            creditals: "same-origin"
          });
        }
      }

      async function removeComment(video, frame, commentId) {
        response = await fetch("/remove_comment/"+ video +"/"+ frame +"/"+ commentId, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          creditals: "same-origin",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({})
        });
      }

      function toggle3DVisualizationVisible(visible) {
        byId("threed-visualization-container").style.display = visible ? "" : "none";
      }

      function toggleRTCConnection() {
        let url = byId("threed-visualization-url-box").value;
        let button = byId("threed-visualization-connect-button");
        let container = byId("webrtc-container");
        if(!!window.rtcConnected) {
          window.rtcConnected = false;
          container.style.display = "none";
          button.value = "Connect";
          for (let key in (window.webRtcServerList || [])) {
            webRtcServerList[key].disconnect();
          }
        }
        else {
          window.rtcConnected = true;
          button.value = "Disconnect";
          initWebRTC(url);
          if(!!webRtcServerList && !!webRtcServerList["video_window_0"])
            webRtcServerList["video_window_0"].dataChannel.send(JSON.stringify({"class_name": "webapp/input", "frame_idx": window.activeFrame, "video_id": window.activeVideo}));

          window.rtcInitInterval = window.setInterval(() => {
            if(!!webRtcServerList && !!webRtcServerList["video_window_0"] && !!webRtcServerList["video_window_0"].dataChannel && webRtcServerList["video_window_0"].dataChannel.readyState == "open") {
              webRtcServerList["video_window_0"].dataChannel.send(JSON.stringify({"class_name": "webapp/input", "frame_idx": window.activeFrame, "video_id": window.activeVideo}));
              window.clearInterval(window.rtcInitInterval);
              container.style.display = "";
            }
          }, 200);
        }
      }

      let selectPrevFrame = debounce(() => selectFrame(window.activeFrame - parseInt(byId("seeker-speed-select").value)));
      let selectNextFrame = debounce(() => selectFrame(window.activeFrame + parseInt(byId("seeker-speed-select").value)));
    </script>
    <script src="/static/scripts/webrtcstreamer.js"></script>
  </head>
  <body onmousemove="javascript:windowMouseMove(event);" onmouseup="javascript:windowMouseUp(event)" onmouseleave="javascript:windowLeave(event)">
    <div class="main-container">
      <div class="frame-container">
        <div class="active-video-container">

          <div id="frame-detail-box" style="display: none;">
            <div id="frame-detail-box-title">🖼️ P09_07_0000032</div>
            <div id="frame-detail-box-header"><span id="frame-detail-box-header-intern">Available HOS data:</span></div>
            <!--<div><span class="frame-detail-box-frame-id">42e4</span>: 0 to 1000 seg.; 0 to 3312 total</div>-->
            <span id="frame-detail-box-loading-label">Loading...</span>
            <span id="frame-detail-box-not-processed-label">Frame not processed</span>
            <div id="frame-detail-box-contents" style="display: none;">
            </div>
          </div>

          <div id="selected-video-name"></div>
          <table id="active-frame-container">
          </table>
          <div class="active-frame-tools">
            <div class="seeker-nav-button" id="seeker-play-pause-button" onclick="javascript:toggleAnimation(!window.animationTimer);" title="Play">▶️</div>
            <div class="seeker-nav-button" id="seeker-prev-button" onclick="javascript:selectPrevFrame();" title="Previous frame">⬅️</div>
            <div id="seeker" onmouseup="javascript:seekerMouseUp(event);"><div id="seeker-filling"></div> <div id="seeker-button" onmousedown="javascript:seekerButtonMouseDown(event);"></div></div>
            <div class="seeker-nav-button" id="seeker-next-button" onclick="javascript:selectNextFrame();" title="Next frame">➡️</div>
            <select id="seeker-speed-select">
              <option value="1">1x</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="5">5x</option>
              <option value="7">7x</option>
              <option value="10">10x</option>
              <option value="15">15x</option>
              <option value="30">30x</option>
              <option value="60">60x</option>
              <option value="120">120x</option>
              <option value="180">180x</option>
              <option value="240">240x</option>
              <option value="300">300x</option>
              <option value="600">600x</option>
            </select>
            <div class="video-position-info">
              <div class="video-position-info-label" title="Frame number">#️⃣</div>
              <div id="video-position-frames" title="Frame number">.....</div>
              <div class="video-position-separator">/</div>
              <div id="video-duration-frames" title="Number of frames in video"> .....</div>
            </div>
            <div class="video-position-info">
              <div class="video-position-info-label" title="Frame timestamp">⏱️</div>
              <div id="video-position-time"title="Frame timestamp">..:..:..</div>
              <div class="video-position-separator">/</div>
              <div id="video-duration-time"title="Duration of video">..:..:..</div>
            </div>
          </div>
          <div class="control-container">
            <div class="layers-label">🧩 Layers</div>
            <div class="layer-selection">
              <div>
                <input type="checkbox" id="layer-selection-box-image" onclick="javascript:toggleChannel('image', this.checked);" checked="true" readonly="true" />
                <label for="layer-selection-box-image">🎨 RGB image</label>
                <div class="layer-seeker" id="layer-seeker-image" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-image" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-image" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>
              
              <div class="indented-layer-div image-filtering-container">
                <span>Version:</span>
                <select id="filter-image-version-box" onchange="javascript:if(this.enabled) { changeImageSource(this.value); }">
                  <option value="image">Original</option>
                </select>
              </div>
              
              <div>
                  <input type="checkbox" id="layer-selection-box-gt-activity" onclick="javascript:return false;" checked="true" readonly="true" />
                  <label for="layer-selection-box-gt-activity">⛹️ GT activity</label>
                  <div class="layer-seeker" id="layer-seeker-gt-activity" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                    <div id="layer-seeker-indicator-gt-activity" class="layer-seeker-indicator"></div>
                    <div id="layer-seeker-mouse-indicator-gt-activity" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                  </div>
              </div>
              <div class="indented-layer-div">
                Current: <span id="current-gt-activity">?</span>
              </div>
              <div class="separator"></div>

              <div>
                <input type="checkbox" id="layer-selection-box-hand-mesh" onclick="javascript:toggleChannel('hand_mesh', this.checked);" checked="false" />
                <label for="layer-selection-box-hand-mesh">🤚 Hand mesh</label>
                <div class="layer-seeker" id="layer-seeker-hand-mesh" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-hand-mesh" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-hand-mesh" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>

              <div class="indented-layer-div hand-mesh-track-history-container">
                <span>Version:</span>
                <select id="filter-hand-mesh-version-box" onchange="javascript:if(this.enabled) { changeHandMeshVersion(this.value); }">
                  <option value="{{DEFAULT_HAND_MESH_VERSION}}">{{DEFAULT_HAND_MESH_VERSION_NAME}}</option>
                </select>
              </div>

              <!--
              <div class="indented-layer-div hand-mesh-track-history-container">
                Track history: <input type="number" minimum="1" maximum="10" id="hand-mesh-track-history" value="1" size="3" /> Step: <input type="number" minimum="1" maximum="100" id="hand-mesh-track-step" value="30" /> <input type="checkbox" class="hand-mesh-track-box" id="hand-mesh-track-left-box" onchange="javascript:fetchFrame()" /> <label class="hand-mesh-track-label" for="hand-mesh-track-left-box">Left</label> <input type="checkbox" class="hand-mesh-track-box" id="hand-mesh-track-right-box" onchange="javascript:fetchFrame()" /> <label class="hand-mesh-track-label" for="hand-mesh-track-right-box">Right</label>
                <span class="hand-mesh-track-color-palette"> <span style="color: {{ HAND_JOINT_COLORS.THUMB }}" title="Thumb">T</span> <span style="color: {{ HAND_JOINT_COLORS.INDEX }}" title="Index finger">I</span> <span style="color: {{ HAND_JOINT_COLORS.MIDDLE }}" title="Middle finger">M</span> <span style="color: {{ HAND_JOINT_COLORS.RING }}" title="Ring finger">R</span> <span style="color: {{ HAND_JOINT_COLORS.LITTLE }}" title="Little finger">L</span> </span>
              </div>
              -->
              <div>
                <input type="checkbox" id="layer-selection-box-hand-bbox" onclick="javascript:toggleChannel('hand_bbox', this.checked);" checked="false" />
                <label for="layer-selection-box-hand-bbox"><div style="border: solid 1px #ccc; float: left; width: 13px; margin-right: 2px">🤚</div> Hand bounding boxes</label>
                <div class="layer-seeker" id="layer-seeker-hand-bbox" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-hand-bbox" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-hand-bbox" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>
              
              <div class="indented-layer-div hand-mesh-filtering-container">
                <span>Filtering:</span> <span>Min. rel. border clearance:</span> <input type="number" min="0.0" max="1.0" step="0.05" id="filter-hand-border-clearance-box" onchange="javascript:fetchFrame();" />
              </div>

              <div class="separator"></div>

              <div>
                <input type="checkbox" id="layer-selection-box-hos" onclick="javascript:toggleChannel('hos', this.checked);" checked="false" />
                <label for="layer-selection-box-hos">🎯 Active object masks</label>
                <div class="layer-seeker" id="layer-seeker-hos" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-hos" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-hos" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>

              <div class="indented-layer-div hos-filtering-container">
                <span>Filtering:</span>
                <span>Version:</span>
                <select id="filter-hos-version-box" onchange="javascript:if(this.enabled) { changeHOSVersion(this.value); }">
                  <option value="threshold={{DEFAULT_HOS_THRESHOLD}}">VISOR, thres. {{DEFAULT_HOS_THRESHOLD}}</option>
                </select>
                <span style="color: #00f;" title="Left hand detections colored in blue">L</span> <span style="color: #f00;" title="Right hand detections colored in red">R</span> <span style="color: #bb0;" title="Object detections colored in yellow">O</span>
              </div>

              <div>
                <input type="checkbox" id="layer-selection-box-tracking-mask" onclick="javascript:toggleChannel('tracking_mask', this.checked);" checked="false" /> <label for="layer-selection-box-tracking-mask"><div style="border: solid 1.25px #d00;  float: left; width: 12px; height: 12px; margin-right: 3.5px; font-size: 80%; border-radius: 50px; background: #faa; text-align: center; padding-top: 1px;">🐾</div> Tracked H/O masks</label>
                <div class="layer-seeker" id="layer-seeker-tracking-mask" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-tracking-mask" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-tracking-mask" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>
              <div class="indented-layer-div tracking-mask-filtering-container">
                <span>Filtering:</span> <span>IDs:</span> <input type="text" id="filter-tracking-mask-ids" onblur="javascript:fetchFrame();" /> <input type="checkbox" id="filter-tracking-mask-hands" onchange="javascript:fetchFrame();" /> <label for="filter-tracking-mask-hands">Hands</label> <input type="checkbox" id="filter-tracking-mask-objects" onchange="javascript:fetchFrame();" /> <label for="filter-tracking-mask-objects">Objects</label>
                Min. persistence:
                <select id="filter-tracking-mask-min-length-box" onchange="javascript:if(this.enabled) { changeTrackingMaskMinLength(this.value); }">
                  <option value="{{DEFAULT_TRACKING_MASK_MIN_LENGTH}}">{{DEFAULT_TRACKING_MASK_MIN_LENGTH}}</option>
                </select>
              </div>
              <div class="indented-layer-div tracking-mask-filtering-container">
                Max. contour tortuosity: <input type="number" min="0.0" max="1.0" step="0.05" id="filter-tracking-mask-max-tortuosity-box" onchange="javascript:fetchFrame();" />
                Max. Q90 of CD: <input type="number" min="0.0" max="1.0" step="0.001" id="filter-tracking-mask-max-cd-box" onchange="javascript:fetchFrame();" />
                Max. hand IoA: <input type="number" min="0.0" max="1.0" step="0.001" id="filter-tracking-mask-max-hand-ioa-box" onchange="javascript:fetchFrame();" />
              </div>
              
              <div class="indented-layer-div tracking-mask-filtering-container">
                Merging: <label><input type="checkbox" id="filter-tracking-mask-merge-tracks-box" onchange="javascript:fetchFrame();" /> Merge tracks</label>
                <span style="display: none">
                  <label><input type="checkbox" id="filter-tracking-mask-merge-framewise-box" onchange="javascript:fetchFrame();" /> Frame-wise</label>
                </span>
              </div>              
              <div class="indented-layer-div tracking-mask-filtering-container">
                <label><input type="checkbox" id="filter-tracking-mask-merge-using-iou-box" onchange="javascript:fetchFrame();" />Min. frame-wise IoU:</label>
                <input type="number" min="0.0" max="1.0" step="0.05" id="filter-tracking-mask-merging-min-iou-box" onchange="javascript:fetchFrame();" />
                <label><input type="checkbox" id="filter-tracking-mask-merge-using-ioa-box" onchange="javascript:fetchFrame();" />Min. frame-wise IoA:</label>
                <input type="number" min="0.0" max="1.0" step="0.05" id="filter-tracking-mask-merging-min-ioa-box" onchange="javascript:fetchFrame();" />
                Min. inters. fraction: <input type="number" min="0.0" max="1.0" step="0.001" id="filter-tracking-mask-merging-min-fraction-box" onchange="javascript:fetchFrame();" />
              </div>              

              <div class="indented-layer-div tracking-mask-filtering-container">
              </div>

              <div><input type="checkbox" id="layer-selection-box-segmentation-mask" onclick="javascript:toggleChannel('segmentation_mask', this.checked);" checked="false" />
                <label for="layer-selection-box-segmentation-mask"><div style="border: dashed 1.75px #007;  float: left; width: 11px; height: 11px; margin-right: 3.5px; border-radius: 50px; background: #aaf;"> </div> Segmentation masks</label>
                <div class="layer-seeker" id="layer-seeker-segmentation-mask" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-segmentation-mask" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-segmentation-mask" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>
              <div class="indented-layer-div segmentation-mask-filtering-container">
                <span>Filtering:</span> <span>Min. area:</span> <input type="number" min="0" max="1000000" step="50" id="filter-segmentation-mask-area-box" onchange="javascript:fetchFrame();" />
                
                <span>Version:</span>
                <select id="filter-segmentation-mask-version-box" onchange="javascript:if(this.enabled) { changeSegmentationMaskVersion(this.value); }">
                  <option value="full_image">Full image</option>
                  <option value="threshold={{DEFAULT_HOS_THRESHOLD}}">VISOR, thres. {{DEFAULT_HOS_THRESHOLD}}</option>
                </select>
              </div>
              
              <div>
                <input type="checkbox" id="layer-selection-box-object-bbox" onclick="javascript:toggleChannel('object_bbox', this.checked);" checked="false" /> <label for="layer-selection-box-object-bbox"><div style="border: dashed 1.75px #007;  float: left; width: 11px; height: 11px; margin-right: 3.5px"> </div> Object bounding boxes</label>
                <div class="layer-seeker" id="layer-seeker-object-bbox" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                  <div id="layer-seeker-indicator-object-bbox" class="layer-seeker-indicator"></div>
                  <div id="layer-seeker-mouse-indicator-object-bbox" class="layer-seeker-mouse-indicator" style="display: none;"></div>
                </div>
              </div>
              <div class="indented-layer-div object-bbox-filtering-container">
                <span>Filtering:</span>
                <span>Version:</span>
                <select id="filter-object-bbox-version-box" onchange="javascript:if(this.enabled) { changeObjectBboxVersion(this.value); }">
                  <option value="unidet_image">UniDet (original image)</option>
                </select>
                <span>Min. confidence:</span> <input type="number" min="0.0" max="1.0" step="0.05" id="filter-object-confidence-box" onchange="javascript:fetchFrame();" />
              </div>

              <div><input type="checkbox" id="layer-selection-box-tracking-bbox" onclick="javascript:toggleChannel('tracking_bbox', this.checked);" checked="false" /> <label for="layer-selection-box-tracking-bbox"><div style="border: dashed 1.75px #007;  float: left; width: 12px; height: 12px; margin-right: 3.5px; font-size: 80%; text-align: center; padding-bottom: 1px;">🐾</div> Tracked boxes</label>
              <div class="layer-seeker" id="layer-seeker-tracking-bbox" onmouseenter="javascript:layerSeekerEntered(this);" onmouseleave="javascript:layerSeekerLeft(this);" onmousemove="javascript:layerSeekerMouseMoved(this, event);">
                <div id="layer-seeker-indicator-tracking-bbox" class="layer-seeker-indicator"></div>
                <div id="layer-seeker-mouse-indicator-tracking-bbox" class="layer-seeker-mouse-indicator" style="display: none;"></div>
              </div></div>
              
              <div class="indented-layer-div tracking-control-container">
                <label><input type="checkbox" id="tracking-hand-bbox-box" onclick="javascript:toggleTrackingChannel('hand_bbox', this.checked);" /> <div style="border: solid 1px #ccc; display: inline-block; width: 13px; margin-right: 0px">🤚</div></label>
                <label><input type="checkbox" id="tracking-hos-box" onclick="javascript:toggleTrackingChannel('hos', this.checked);" /> 🎯</label>
                <label><input type="checkbox" id="tracking-segmentation-mask-box" onclick="javascript:toggleTrackingChannel('segmentation_mask', this.checked);" /> <div style="border: dashed 1.75px #007; display: inline-block; width: 11px; height: 11px; border-radius: 50px; background: #aaf; margin-bottom: -1px;"> </div></label>
                <label><input type="checkbox" id="tracking-object-bbox-box" onclick="javascript:toggleTrackingChannel('object_bbox', this.checked);" /> <div style="border: dashed 1.75px #007; display: inline-block; width: 11px; height: 11px; margin-bottom: -1px"> </div></label>
              </div>
              <div class="indented-layer-div tracking-bbox-filtering-container">
                <span>Filtering:</span> <span>IDs:</span> <input type="text" id="filter-tracking-bbox-ids" onblur="javascript:fetchFrame();" />
              </div>

              <div><input type="checkbox" id="layer-selection-box-box-labels" onclick="javascript:toggleChannel('box_labels', this.checked);" checked="false" /> <label for="layer-selection-box-box-labels">🏷️ Box labels</label>
              </div>
              
            <div id="threed-visualization-container">
              <div class="threed-visualization-label">👓 3D visualization</div>
              <div class="threed-visualization-control">URL: <input type="text" id="threed-visualization-url-box" value="http://2.tcp.eu.ngrok.io:19356/" /> <input type="button" value="Connect" id="threed-visualization-connect-button" onclick="javascript:toggleRTCConnection();" /></div>
              <div id="webrtc-container"></div>
            </div>


            <div class="grid-label">🔢 Grid</div>
            <div class="grid-control">
                <div><span style="margin-right: 5px;">Rows / columns:</span> <input type="number" id="grid-rows" min="1" max="10" size="2" value="1" onchange="javascript:recomputeGrid();" /> x <input type="number" id="grid-cols" min="1" max="10" size="2" value="1" onchange="javascript:recomputeGrid();" /> Step: <input type="number" id="grid-history-step" min="1" max="1000" size="3" value="1" /> <input type="button" class="grid-history-button" value="🕒" onclick="javascript:applyGridHistoryConfiguration();" /> </div>
                <div>Grid configuration:</div>
            </div>
            <table id="grid-configurator">
            </table>
            <div class="comments-label">💬 Comments</div>
            <span id="no-comments-label">No comments yet.</span>
            <div id="comment-list">
            </div>
            <div> <button onclick="javascript:createComment2();">➕ New comment</button> </div>
          </div>
        </div>
      </div>
      <div class="navigation-container">
        {% for video in videos %}
        <div class="video-entry" id="video-entry-{{video.name}}" onclick="javascript:selectVideo('{{video.name}}');">
          <img class="video-thumbnail" src="{% static "img/video_thumbnails/mini/"|add:video.name|add:".jpg" %}" />
          <div class="video-name">{{video.name}}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <style type="text/css">
      #frame-detail-box {
        position: absolute;
        width: 300px;
        display: flex;
        flex-direction: column;
        background: #fafafa;
        padding: 5px;
        border-radius: 5px;
        z-index: 9999999999;
        border: solid 1px {{border_color}};
      }
      #frame-detail-box-title {
        padding-bottom: 2px;
        border-bottom: solid 1px {{border_color}};
        margin-bottom: 5px;
        font-weight: bold;
      }
      #frame-detail-box-header {
        margin-bottom: 5px;
      }
      #frame-detail-box-header-intern {
        padding-bottom: 2px;
        border-bottom: solid 1px {{border_color}};
        display: inline-block;
      }
    </style>

    <script>
      byId('seeker-speed-select').value = "1";
      /*byId('hand-mesh-track-left-box').checked = false;
      byId('hand-mesh-track-right-box').checked = false;
      byId('hand-mesh-track-history').value = 4;
      byId('hand-mesh-track-step').value = 60;*/
      byId('grid-rows').value = 1;
      byId('grid-cols').value = 1;
      byId('filter-hand-border-clearance-box').value = 0.0;
      byId('filter-object-confidence-box').value = 0.3;
      byId('filter-segmentation-mask-area-box').value = 1000;
      byId('filter-tracking-mask-max-tortuosity-box').value = {{DEFAULT_TRACKING_MASK_MAX_TORTUOSITY}};
      byId('filter-tracking-mask-max-cd-box').value = {{DEFAULT_TRACKING_MASK_MAX_CD_Q90}};
      byId('filter-tracking-mask-max-hand-ioa-box').value = {{DEFAULT_TRACKING_MASK_MAX_HAND_IOA}};
      byId('filter-hos-version-box').value = "threshold={{DEFAULT_HOS_THRESHOLD}}";
      byId('layer-selection-box-image').checked = true;
      byId('layer-selection-box-box-labels').checked = true;
      byId('layer-selection-box-gt-activity').checked = true;
      byId('layer-selection-box-hand-mesh').checked = false;
      byId('layer-selection-box-hand-bbox').checked = false;
      byId('layer-selection-box-hos').checked = false;
      byId('layer-selection-box-segmentation-mask').checked = false;
      byId('layer-selection-box-object-bbox').checked = false;
      byId('layer-selection-box-tracking-bbox').checked = false;
      byId('layer-selection-box-tracking-mask').checked = false;
      byId('filter-tracking-mask-hands').checked = false;
      byId('filter-tracking-mask-objects').checked = true;
      byId('filter-tracking-mask-merge-tracks-box').checked = true;
      byId('filter-tracking-mask-merge-framewise-box').checked = true;
      byId('filter-tracking-mask-merge-using-iou-box').checked = true;
      byId('filter-tracking-mask-merge-using-ioa-box').checked = false;
      byId('filter-tracking-mask-merging-min-iou-box').value = {{DEFAULT_TRACKING_MASK_MERGING_OVERLAP_FRAME_IOU_FRACTION}};
      byId('filter-tracking-mask-merging-min-ioa-box').value = {{DEFAULT_TRACKING_MASK_MERGING_OVERLAP_FRAME_IOA_FRACTION}};
      byId('filter-tracking-mask-merging-min-fraction-box').value = {{DEFAULT_TRACKING_MASK_MERGING_OVERLAP_FRAME_COUNT_FRACTION}};
      
      byId('tracking-hand-bbox-box').checked = false;
      byId('tracking-hos-box').checked = false;
      byId('tracking-segmentation-mask-box').checked = false;
      byId('tracking-object-bbox-box').checked = false;
      recomputeGrid();
      selectVideo("P09_07");
    </script>
  </body>
</html>
{% endwith %}
{% endwith %}